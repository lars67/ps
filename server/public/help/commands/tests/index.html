<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Tests</title>
    <title>Portfolios</title>
    <link rel="stylesheet" href="../../style.css">
    <link rel="stylesheet" href="../../cm-viewer.css">
    <link rel="stylesheet" href="../../contextMenu.css">
    <script src="../../contextMenu.js"></script>
</head>
<body>
<h1 id="manual">Tests</h1>
<p>Execute test commands on the client side, enabling the creation of tests alongside other commands</p>
<p>Test commands can create and utilize variables with arbitrary values during the execution of the command package.
Creating a variable is done using the parameter "_as"="name_variable". Adding this parameter to any command allows creating a variable with the value of the "data" field.Example save command output(which present in field 'data' will be saved in variable with name 'response' :</p>
<div class="cm-line">{<span class="ͼ1m">"command"</span>:<span class="ͼ19">"portfolios.add"</span>,<span class="ͼ1m">"name"</span>:<span class="ͼ19">"_testErrorInputPortfolio"</span>,<span class="ͼ1m">"_as"</span>:<span class="ͼ19">"response"</span>, <span class="ͼ1m">"currency"</span>:<span class="ͼ19">"USD"</span>, <span class="ͼ1m">"baseInstrument"</span>:<span class="ͼ19">"SPY"</span>}</div>
<p>Output this command looks as :</p>
<pre>
    {
    "command": "portfolios.add",
    "msgId": 16,
    "data": {
        "name": "_testErrorInputPortfolio",
        "currency": "USD",
        "userId": "65dd09760689c3bd1c0ff45a",
        "baseInstrument": "SPY",
        "_id": "6614ea8a5684c7131cd42793",
        }
    }
</pre>
<p>Variable with name 'response' will be object from field "data":
<pre>
    response ={
        "name": "_testErrorInputPortfolio",
        "currency": "USD",
        "userId": "65dd09760689c3bd1c0ff45a",
        "baseInstrument": "SPY",
        "_id": "6614ea8a5684c7131cd42793",
    }
</pre>
</p>
Command:
<div class="cm-activeLine cm-line">{<span class="ͼ1m">"command"</span>:<span class="ͼ19">"portfolios.list"</span>, <span class="ͼ1m">"filter"</span>: {<span class="ͼ1m">"name"</span>:<span class="ͼ19">"_testErrorInputPortfolio"</span>}, <span class="ͼ1m">"_as"</span>:<span class="ͼ19">"result"</span>}</div>
create variable with name 'result' and type array from field 'data':
<pre>
    {
  "command": "portfolios.list",
  "msgId": 17,
  "data": [
    {
      "_id": "6614ea8a5684c7131cd42793",
      "name": "_testErrorInputPortfolio",
      "currency": "USD",
      "userId": "65dd09760689c3bd1c0ff45a",
      "baseInstrument": "SPY",
      "__v": 0
    }
  ]
</pre>
<p>Access to variable can be done in tests commands with field "path", in this example we use variable with name 'result' which contain array and we use first item from array and check field 'name' in conditions:</p>
<div class="cm-activeLine cm-line">{<span class="ͼ1m">"command"</span>:<span class="ͼ19">"tests.check"</span>, <span class="ͼ1m">"path"</span>: <span class="ͼ19">"result.0"</span>, <span class="ͼ1m">"conditions"</span>: {<span class="ͼ1m">"name"</span>: {<span class="ͼ1m">"$eq"</span>: <span class="ͼ19">"_testErrorInputPortfolio"</span>}},  <span class="ͼ1m">"description"</span>: <span class="ͼ19">"Check that returned porfolio with requested name"</span>}</div>
<p>Another variant usage variable in tests is use $var. It is root ot all variables, which allow get variable with name 'somename' as $var.somename , for array type used $var.somename.0.fieldname  </p>
<p>In next test we  check value from result.0._id with $var.pid. It is mean that we check  variables: result[0]._id and pid</p>
<div class="cm-line">{<span class="ͼ1m">"command"</span>:<span class="ͼ19">"tests.check"</span>, <span class="ͼ1m">"path"</span>: <span class="ͼ19">"result.0"</span>, <span class="ͼ1m">"conditions"</span>: {<span class="ͼ1m">"_id"</span>: {<span class="ͼ1m">"$eq"</span>: <span class="ͼ19">"$var.pid"</span>}},  <span class="ͼ1m">"description"</span>: <span class="ͼ19">"Check that variable with name 'pid'= portfolio._id"</span>}</div>
<p> Acces to some array item can be done with help some filter which defined as [field=value] </p>
Below we find object in variable with name 'history1' which has propery 'days' with type array inside which we find item which have prroperty 'name with value '2024-01-24':

<h3>Access to variable</h3>
<table>
    <tr>
        <th>Acceess</th>
        <th></th>
        <th>Examle</th>
    </tr>
    <tr>
        <td>With propery 'path'</td>
        <td>Some test commands check,getVar has propery 'path' </td>
        <td><div class="cm-activeLine cm-line">{<span class="ͼ1m">"command"</span>:<span class="ͼ19">"tests.check"</span>, <span class="ͼ1m">"path"</span>: <span class="ͼ19">"result.0"</span>, <span class="ͼ1m">"conditions"</span>: {<span class="ͼ1m">"name"</span>: {<span class="ͼ1m">"$eq"</span>: <span class="ͼ19">"_testErrorInputPortfolio"</span>}},  <span class="ͼ1m">"description"</span>: <span class="ͼ19">"Check porfolio with requested name"</span>}</div>
        </td>
    </tr>
    <tr>
        <td>With $var'</td>
        <td>In test commands variable can be inserted in some property</td>
        <td><div class="cm-line">{<span class="ͼ1m">"command"</span>: <span class="ͼ19">"tests.setVar"</span>, <span class="ͼ1m">"v"</span>:{<span class="ͼ1m">"pid"</span>: <span class="ͼ19">"$var.result.0._id"</span> }}</div></td>
    </tr>
    <tr>
        <td>Variable array property insex access</td>
        <td>For array property in variable can be used acces by index .1.
        <td></td>
    </tr>
    <tr>
        <td>Variable array property </td>
        <td>For array property in variable can be used find as [symbol=INTC]
        <td><div class="cm-line">{<span class="ͼ1m">"command"</span>: <span class="ͼ19">"tests.getVar"</span>,<span class="ͼ1m">"path"</span>:<span class="ͼ19">"position2.[symbol=XLC].weight"</span>}</div></td>
    </tr>

</table>
    <div class="cm-activeLine cm-line"><span class="cm-matchingBracket">{</span><span class="ͼ1m">"command"</span>:<span class="ͼ19">"tests.check"</span>,<span class="ͼ1m">"path"</span>:<span class="ͼ19">"history1.days.[date=2024-01-24]"</span>,<span class="ͼ1m">"conditions"</span>:{<span class="ͼ1m">"cash"</span>: {<span class="ͼ1m">"$sub"</span>: <span class="ͼ1a">8</span>},<span class="ͼ1m">"nav"</span>: {<span class="ͼ1m">"$sub"</span>: <span class="ͼ1a">101010</span>} }, <span class="ͼ1m">"description"</span>:<span class="ͼ19">"compare 2024-01-24 nav, cash with PS"</span><span class="cm-matchingBracket">}</span></div>
<h3>Block test commands with names</h3>
<p>This commands contain base test  for testing</p>
<ul>
    <li><b>tests_portfolio.add</b>: Tests with portfolio add operations</li>
    <li><b>tests_portfolio.remove</b>: Tests with portfolio remove operations</li>
    <li><b>tests_portfolio.history</b>: Tests with portfolio history operations</li>
    <li><b>tests_portfolio.positions</b>: Tests with portfolio positions operations</li>
</ul>
<table>
    <tr>
        <th>Command</th>
        <th>Call</th>
    </tr>
    <tr>
        <td><a href="#to-check">Check</a></td>
        <td><div class="cm-activeLine cm-line">{<span class="ͼ1m">"command"</span>:<span class="ͼ19">"tests.check"</span>,<span class="ͼ1m">"path"</span>:<span class="ͼ19">"?"</span>,<span class="ͼ1m">"conditions"</span>:{}}</div>
        </td>

    </tr>
    <tr>
        <td><a href="#to-setVar">Set variable</a></td>
        <td>
            <div class="cm-line">{<span class="ͼ1m">"command"</span>:<span class="ͼ19">"tests.setVar"</span>,<span class="ͼ1m">"v"</span>:<span class="ͼ19">"?"</span>}</div>
        </td>
    </tr>
    <tr>
        <td><a href="#to-getVar">Get variable</a></td>
        <td><div class="cm-line">{<span class="ͼ1m">"command"</span>:<span class="ͼ19">"tests.getVar"</span>,<span class="ͼ1m">"path"</span>:<span class="ͼ19">"?"</span>}</div>
        </td>
     </tr>
    <tr>
        <td><a href="#to-setMode">Set output mode</a></td>
        <td>
          <div class="cm-line">{<span class="ͼ1m">"command"</span>:<span class="ͼ19">"tests.setMode"</span>,<span class="ͼ1m">"hide"</span>:<span class="ͼ1b">true</span>}</div>
        </td>
    </tr>

</table>

<h3 id="to-check">Check</h3>

<table>
    <tr>
        <th>Parameter</th>
        <th>Value</th>
        <th>Required</th>
    </tr>
    <tr>
        <td>path</td>
        <td>Variable by path</td>
        <td>Yes</td>
    </tr>
    <tr>
        <td>conditions</td>
        <td>Object which contain conditions for check varible defined by path
        Format this object: {field: {condition: value}}
            Where condition:
            <ul>
                <li>$eq  "conditions": {"$var.nm": {"$eq": "myname"}}</li>
                <li>$gt  "conditions": {"length": {"$gt": 1}}</li>
                <li>$lt "conditions": {"field": {"$lt": $var.number}}</li>
                <li>$isArray "conditions": {"*": {"$isArray": true}}</li>
                <li>$isObject "conditions": {"field": {"$isObject": true}}</li>
                <li>$absent "conditions":{"field": {"$absent": true}}</li>
                <li>$has "conditions":{"error": {"$has": true}}</li>
                <li>$sub "conditions":{"field": {"$sub": 10000}}</li>
                $sub calculate ABS( value_from_object_path - value from $sub) <1, so tolerancy =1
            </ul>

        </td>
        <td>Yes</td>
    </tr>
    <tr>
        <td>description</td>
        <td>Check description</td>
        <td>Yes</td>
    </tr>

</table>

<h3 id="to-setVar">Set variable</h3>
<p> Add variable object to variables. v</p>
<table>
    <tr>
        <th>Parameter</th>
        <th>Value</th>
        <th>Required</th>
    </tr>
    <tr>
        <td>v</td>
        <td><p>Add object v ={field:value} to variables as variable with name field and value. Can be added multiple variables with v={var1:1, var2:2}</p></td>
        <td>Yes</td>
    </tr>

</table>

<h3 id="to-getVar">Get variable</h3>
<p> Get variable (print)</p>
<table>
    <tr>
        <th>Parameter</th>
        <th>Value</th>
        <th>Required</th>
    </tr>
    <tr>
        <td>path</td>
        <td>Get variable by it path></td>
        <td>Yes</td>
    </tr>

</table>

<h3 id="to-setMode">Set output mode</h3>
<table>
    <tr>
        <th>Parameter</th>
        <th>Value</th>
        <th>Required</th>
    </tr>
    <tr>
        <td>hide</td>
        <td>When true hide non test command output for all next commands</td>
        <td>Yes</td>
    </tr>

</table>
</body>
</html>
