<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PS2 Guest WebSocket Demo</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        textarea { width: 100%; height: 100px; }
        button { margin: 10px 0; padding: 10px; }
        #responses { border: 1px solid #ccc; padding: 10px; max-height: 400px; overflow-y: auto; }
        .response { margin: 10px 0; padding: 10px; border: 1px solid #ddd; }
    </style>
</head>
<body>
    <h1>PS2 Guest WebSocket Demo</h1>
    <p>Connection Status: <span id="status">Disconnected</span></p>

    <label for="command">Command JSON:</label><br>
    <textarea id="command">{"command": "commands.list", "msgId": "1"}</textarea><br>

    <button onclick="sendCommand()">Send Command</button>
    <button onclick="clearResponses()">Clear Responses</button>

    <h2>Responses</h2>
    <div id="responses"></div>

    <script>
        let ws;
        let msgId = 1;
        const fragments = {};
        const statusEl = document.getElementById('status');
        const commandEl = document.getElementById('command');
        const responsesEl = document.getElementById('responses');

        function connect() {
            ws = new WebSocket('wss://localhost:3334');

            ws.onopen = function(event) {
                statusEl.textContent = 'Connected';
                console.log('Connected to WebSocket');
            };

            ws.onmessage = function(event) {
                const message = JSON.parse(event.data);
                const { data, msgId, total, index } = message;

                if (!fragments[msgId]) {
                    fragments[msgId] = [];
                }
                fragments[msgId][index] = data;

                if (fragments[msgId].length === total) {
                    const assembledMessage = fragments[msgId].join('');
                    delete fragments[msgId];
                    const parsed = JSON.parse(assembledMessage);
                    displayResponse(msgId, parsed);
                }
            };

            ws.onclose = function(event) {
                statusEl.textContent = 'Disconnected';
                console.log('Disconnected from WebSocket');
            };

            ws.onerror = function(error) {
                statusEl.textContent = 'Error';
                console.error('WebSocket error:', error);
            };
        }

        function sendCommand() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                try {
                    const cmd = JSON.parse(commandEl.value);
                    cmd.msgId = msgId.toString();
                    ws.send(JSON.stringify(cmd));
                    msgId++;
                } catch (error) {
                    alert('Invalid JSON: ' + error.message);
                }
            } else {
                alert('WebSocket is not connected');
            }
        }

        function displayResponse(msgId, data) {
            const responseDiv = document.createElement('div');
            responseDiv.className = 'response';
            responseDiv.innerHTML = `
                <strong>MsgId: ${msgId}</strong><br>
                <pre>${JSON.stringify(data, null, 2)}</pre>
            `;
            responsesEl.appendChild(responseDiv);
            responsesEl.scrollTop = responsesEl.scrollHeight;
        }

        function clearResponses() {
            responsesEl.innerHTML = '';
        }

        // Connect on page load
        connect();
    </script>
</body>
</html>
